<!--suppress ALL -->
<style type="text/css">
.btn_nav{float:right;margin-top:10px;}
.prev,.next{width:100px; height:32px; line-height:32px; background:url(btn_bg.gif) repeat-x bottom; border:1px solid #d3d3d3; cursor:pointer;}
.myhiden{width:100px; height:32px;}
.myoneday{width:32px; height:32px; line-height:32px; text-align:center;border:1px solid #d3d3d3; cursor:pointer;float:left}
.myonedayselected{background-color:#8ccad5}
.status_waiting_fonts{
     background: url(/static/images/loading.gif) no-repeat;
     background-position: 170px 5px;
     background-size: 20px;
     font-size: 18px;
     font-weight: bold;
 }
.status_waiting_icon{
     background: url(/static/images/arrow_right.png) no-repeat;
     background-position: 17px;
     width: 50px;
     padding: 0;
     background-size: 20px;
}

.status_checked_icon{
     background: url(/static/images/check_mark.png) no-repeat;
     background-position: 17px;
     width: 50px;
     padding: 0;
     background-size: 15px;
}
.status_todo_icon{
     background: url(/static/images/tripledots.png) no-repeat;
     background-position: 17px;
     width: 50px;
     padding: 0;
     background-size: 15px;
}
.client_search{
    border: 2px solid #dce4ec;
    color: #34495e;
    font-family: "Lato", sans-serif;
    font-size:14px;
    padding: 3px 0 3px 10px;
    width: 200px;
    background:#fff url(/static/images/icon_search_1649.gif) no-repeat right;
}
#tabs-6 input {
    height: 18px;
}
.set_disk_step_button:hover{
    color:orange;
    text-decoration: underline;
}
</style>

{% include 'restore_migrate_cm.html' %}

<div class="right">
	<div id="tabs">
		<ul>
		<li><a href="#tabs-1">源客户端</a></li>
		<li><a href="#tabs-2">目标机</a></li>
        <li><a href="#tabs-3">平台检测</a></li>
        <li><a href="#tabs-4">更新驱动</a></li>
        <li><a href="#tabs-5">选择驱动版本</a></li>
		<li><a href="#tabs-6">设置目标及网卡</a></li>
		<li><a href="#tabs-7">设置目标机硬盘</a></li>
        <li><a href="#tabs-shell">执行脚本</a></li>
		</ul>
		<div id="tabs-1" style="margin-top:0px;margin-left:30px;">
			<div style="margin-bottom:10px;">选择需要迁移的客户端</div>
			<div style="float:left;"><input name="client_search" type="text" placeholder="开始搜索" class="client_search"/></div>
                <div id="RefreshSrcServer" style="cursor:pointer;float:right;margin-right:49px;">刷新连接列表</div>
			<div class="clear"></div>
			<div id="Servers_Tree1" class="aciTree" style="width:95%;height:200px;border:1px solid #ccc;overflow:auto;"></div>
			<br />源客户端详细描述
			<div style="height:262px;overflow:auto;">
				<table width="95%" cellpadding="0" cellspacing="1" class="border_table">
					<tr height="25">
						<td width="30%" align="left">客户端名称</td>
						<td width="70%"><div id="show_clientname_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">计算机名</td>
						<td align="left"><div id="show_pcname_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">IP地址</td>
						<td align="left"><div id="show_ipaddrs_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">MAC地址</td>
						<td align="left"><div id="show_macaddrs_src">‎</div></td>
					</tr>
					<tr height="25">
						<td align="left">操作系统</td>
						<td align="left"><div id="show_os_type_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">Build Num</td>
						<td align="left"><div id="show_build_num_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">磁盘数量</td>
						<td align="left"><div id="show_disk_num_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">磁盘信息</td>
						<td align="left"><div id="show_disk_info_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">总容量</td>
						<td align="left"><div id="show_disk_total_src"></div></td>
					</tr>
					<tr height="25">
						<td align="left">已使用空间</td>
						<td align="left"><div id="show_disk_used_src"></div></td>
					</tr>
				</table>
			</div>
		</div>
		<div id="tabs-2" style="margin-top:30px;margin-left:30px;">
            <div style="margin-bottom:10px;">迁移到客户端</div>
            <div style="float:left;"><input name="client_search2" type="text" placeholder="开始搜索" class="client_search" /></div>
			<div id="RefreshdestServer" style="cursor:pointer;float:right;margin-right:50px;">刷新连接列表</div>
			<br />
			<div id="Servers_Tree2" class="aciTree" style="width:95%;height:200px;border:1px solid #ccc;overflow:auto;"></div>
			<br />目标客户端详细描述
			<div style="height:262px;overflow:auto;">
				<table width="95%" cellpadding="0" cellspacing="1" class="border_table">
					<tr height="25">
						<td width="30%" align="left">客户端名称</td>
						<td width="70%"><div id="show_clientname_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">计算机名</td>
						<td align="left"><div id="show_pcname_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">IP地址</td>
						<td align="left"><div id="show_ipaddrs_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">MAC地址</td>
						<td align="left"><div id="show_macaddrs_tar">‎</div></td>
					</tr>
					<tr height="25">
						<td align="left">操作系统</td>
						<td align="left"><div id="show_os_type_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">Build Num</td>
						<td align="left"><div id="show_build_num_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">磁盘数量</td>
						<td align="left"><div id="show_disk_num_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">磁盘信息</td>
						<td align="left"><div id="show_disk_info_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">总容量</td>
						<td align="left"><div id="show_disk_total_tar"></div></td>
					</tr>
					<tr height="25">
						<td align="left">已使用空间</td>
						<td align="left"><div id="show_disk_used_tar"></div></td>
					</tr>
				</table>
			</div>
		</div>
        <div id="tabs-3">
            <div style="margin-bottom: 10px">平台检测</div>
            <p style="text-indent: 2em;">还原、迁移和验证性还原过程中，需要对目标主机的硬件环境进行检测。</p>
            <div class="ui-widget ui-widget-content ui-corner-all" style="margin-top:10px;overflow-y:auto;height:360px;padding: 20px">
                <div id="check_left">
                    <table width="80%" border="0" cellpadding="5" style="text-align: left; border-collapse:collapse;"  >
                        <tr id="step1">
                            <td class="status_todo_icon"></td>
                            <td style="width: 200px">分配资源中</td>
                            <td></td>
                        </tr>
                        <tr  id="step2">
                            <td class="status_todo_icon"></td>
                            <td style="width: 200px">检测是否异构平台</td>
                            <td></td>
                        </tr>
                        <tr  id="step3">
                            <td class="status_todo_icon"></td>
                            <td style="width: 200px">匹配硬件驱动</td>
                            <td></td>
                        </tr>
                        <tr  id="step4">
                            <td class="status_todo_icon"></td>
                            <td style="width: 200px">查询最新驱动</td>
                            <td></td>
                        </tr>
                    </table>
                </div>
                <div id="check_intro" style="margin-top: 100px;">
                    <p>1分配资源：还原目标机需要启动程序，分配资源。</p>
                    <p style="margin-top: 12px;padding-left: 125px;text-indent: -125px ">2检测是否异构平台：检测目标机与源系统是否是异构系统，若为同构（硬件环境相同），则会跳过步骤三和四。</p>
                    <p style="margin-top: 12px;padding-left: 100px;text-indent: -100px ">3为目标机做差异硬件驱动配置：步骤三中检测结果为异构（硬件环境不同），则会根据目标机中的硬件，在{{ title }}的驱动库中匹配相应的驱动，若完全匹配则跳过步骤四。</p>
                    <p style="margin-top: 12px;padding-left: 100px;text-indent: -100px ">4查询最新驱动：若步骤三中未匹配完全，则会根据未匹配的硬件，去“{{ company }}在线驱动库”查询最新的驱动程序。</p>
                </div>
            </div>
        </div>
        <div id="tabs-4" style="margin-top:30px;margin-left:30px;">
			<input type="hidden" id="aiourl" />
            <div>
                <p style="margin: 0;padding:0;">通过“{{ title }}在线驱动库”查询驱动结果：</p>
                <p style="margin: 0;padding:0;margin-left: 2em;line-height: 2em;">Tip1：若发现有匹配的驱动，点击“下一步”，会出现更新的对话框，请更新此驱动到{{ title }}。</p>
                <p style="margin: 0;padding:0;margin-left: 2em;line-height: 2em;">Tip2：若发现无法解析服务器，说明无法访问网络，请连接到互联网，重新做此步骤。</p>
                <p style="margin: 0;padding:0;margin-left: 2em;line-height: 2em;">Tip3：若发现有未匹配的驱动（可能导致目标机无法启动），请联系超级管理员更新未匹配的驱动。</p>
                <p style="margin: 0;padding:0;margin-left: 2em;line-height: 2em;">源操作系统：<span id="os_info"></span></p>
            </div>
			<div id="drivers_Tree" class="aciTree" style="width:100%;height:350px;border:1px solid #ccc;overflow:auto;"></div>
			<div id="errinfo2" style="display:none;word-break: break-all;height: 75px;overflow: auto;"></div>
		</div>
        <div id="tabs-5" style="margin-top:30px;margin-left:30px;">
			<div>请选择驱动更新模式</div>
			<div id="driver_update_method" class="ui-widget ui-widget-content ui-corner-all" style="margin-top:10px;margin-left:10px;overflow-y:auto;height:420px">
                <div style="margin: 20px 0 10px 20px">默认情况请选择模式一，如果某次迁移失败，再次迁移时候，可以根据情况选择模式二去除可疑驱动。</div>
                <div style="margin: 20px 0 10px 20px">
                    <input type="radio" name="choice_method" value="1" checked="checked"> 模式一：智能匹配最新版本的设备驱动（推荐）
                </div>
                <div style="margin: 20px 0 10px 20px">
                    <input type="radio" name="choice_method" value="2">模式二：选择指定版本的设备驱动（高级）
                </div>
                <div id="choice2_warp" style="margin: 20px 0 0 40px">
                    <div id="driver_version_wrap" style="margin-top: 10px;display: none">
                        <label for="driver_version">平台驱动筛选：</label>
                        <select id="driver_version" style="color: red">
                            <option value="" selected>请选择--</option>
                        </select>
                        <span style="color: red">(发现多个版本平台驱动，请选择特定版本的平台驱动。)</span>
                    </div>
                    <div id="driver_version_tree" class="aciTree" style="margin-top: 10px"></div>
                </div>
			</div>
		</div>
		<div id="tabs-6" style="margin-top:30px;margin-left:30px;">
			<div>设置迁移目标机的IP地址<br /></div>
			<div style="overflow-y:auto;height:420px;padding-right: 10px;">
                <div id="ipsetdiv"></div>
                <div class="clear"></div>
                <p style="margin: 20px 0 10px 0">配置目标机的路由</p>
                <p style="margin: 0 0 10px 0">1：默认选择“使用迁移源路由表”选项，还原后的路由表为备份源路由表。</p>
                <p style="margin: 0 0 10px 0">2：选择“使用目标机路由表”选项，还原后的路由表为目标机路由表。</p>
                <input type="radio" checked="checked" value="1" id="src_routers" name="choice_routers" ><label for="src_routers" style="margin-right: 20px">使用迁移源路由表</label>
                <input type="radio" value="2" id="dest_routers" name="choice_routers"><label for="dest_routers" style="margin-right: 20px">使用目标机路由表</label>
                <div id="router_toogle">
                    <div id="show_src_routers" style="margin-top: 20px;">
                        <div id="src_routes_cfg">
                            <div class="pre_route_cfg" style="border:1px solid #d3d3d3;margin-top:10px">
                                <table width="100%" border="0" cellspacing="5" cellpadding="0">
                                    <tr>
                                        <td align="right" width="20%">目标网络：</td>
                                        <td><input type="text" class="input" name="route_ip"  onblur="removespace(this)"/></td>
                                    </tr>
                                    <tr>
                                        <td align="right">网络掩码：</td>
                                        <td><input type="text" class="input" name="route_mask"  onblur="removespace(this)"/></td>
                                    </tr>
                                    <tr>
                                        <td align="right">网关：</td>
                                        <td><input type="text" class="input" name="route_gateway"  onblur="removespace(this)"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div style="float: right;margin-top: 10px" id="add_src_routes" title="增加下一条路由规则"
                             class="text_button add">增加一条路由
                        </div>
                    </div>
                    <div id="show_dest_routers" style="margin-top: 20px;display: none">
                        <div id="dest_routes_cfg">
                            <div class="pre_route_cfg" style="border:1px solid #d3d3d3;margin-top:10px">
                                <table width="100%" border="0" cellspacing="5" cellpadding="0">
                                    <tr>
                                        <td align="right" width="20%">目标网络：</td>
                                        <td><input type="text" class="input" name="route_ip"  onblur="removespace(this)"/></td>
                                    </tr>
                                    <tr>
                                        <td align="right">网络掩码：</td>
                                        <td><input type="text" class="input" name="route_mask"  onblur="removespace(this)"/></td>
                                    </tr>
                                    <tr>
                                        <td align="right">网关：</td>
                                        <td><input type="text" class="input" name="route_gateway"  onblur="removespace(this)"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div style="float: right;margin-top: 10px" id="add_dest_routes" title="增加下一条路由规则"
                             class="text_button add">增加一条路由
                        </div>
                    </div>
                </div>
            </div>
		</div>
		<div id="tabs-7" style="margin-top:30px;margin-left:30px;">
			<div>选择需要迁移目标机硬盘</div>
			<div id="HardDisks" style="overflow-y:auto;height:340px" ></div>
            <div class="set_disk_step" style="margin-bottom: 30px">
                <h4 class="set_disk_step_header"><span class="set_disk_step_button" style="cursor:pointer;margin-bottom: 10px;">►</span>高级设置</h4>
                <div class="set_disk_step_content" style="display: none">
                    <input type="checkbox" id="fast_restore" v-model="checked">使用快速还原技术<br>
                    <p style="color:grey;margin: 0.5em 0 1em 2em">说明:快速重建技术无需等待所有数据还原到目标主机，能够在仅还原关键热数据后就成功完成业务系统的重建。</p>
                </div>
				<div class="set_disk_step_content" style="display: none">
					<div id="replace_efi_div" style="display: none">
						<input type="checkbox" id="replace_efi">
						<label for="replace_efi">使用科力锐VHCT技术</label>
						<p style="color:grey;margin: 1em 0 1em 2em">
							说明:在某些官方宣称不支持windows 2008 R2及以下版本(如联想S650系列)的硬件平台上，使用本技术后，可使恢复到此类服务器上的windows 2008 R2及以下版本可正常工作。
						</p>
					</div>
				</div>
                <div class="set_disk_step_content" style="display: none;margin-left: 5px">
                    迁移源存储读取队列深度：<input type="number" name="thread-count" id="thread-count" style="width: 32px;height: 13px" value="4" />（2-8）<br>
                    <span class="form_tips" style="margin-left: 21px;">说明：当备份读取速度远小于源存储理论值时, 请调整该值以到达最优备份速度。
                        <div style="margin-left:62px;">--本地磁盘推荐值4</div>
                        <div style="margin-left:62px;">--高时延iSCSI磁盘推荐值6</div>
                        <div style="margin-left:62px;">--高速SAN磁盘推荐值4</div>
                    </span>
                </div>
            </div>
            <div class="clear"></div>
            <div id="tips" style="margin-top: 10px">
                <p style="margin-left: 2em;">Tip1：目标主机的引导盘为目标主机当前BIOS配置项，请确认该目标磁盘是否为预期的还原目标。</p>
                <p style="margin-left: 2em;margin-top: 10px">Tip2：若源引导盘是GPT分区，目标引导盘是MBR分区，请在迁移后，调整引导模式为UEFI。</p>
                <p style="margin-left: 2em;margin-top: 10px">Tip3：快速重建技术无需等待所有数据还原到目标主机，能够在仅还原关键热数据后就成功完成业务系统的重建。</p>
            </div>
		</div>
        <div id="tabs-shell" style="margin-top:30px;margin-left:30px;">

        </div>
	</div>
	<div class="btn_nav">
		<input type="button" id="prev" class="prev" style="float:left" value="&laquo;上一步" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" id="next" class="next" style="float:right" value="下一步&raquo;" />
   </div>
</div>

<div id="divharddiskheader" style="display:none;">
    <div style="border: 1px solid #d3d3d3;float:left;width:45%;height:27px;line-height:27px;text-align:center; vertical-align:middle;">源服务器硬盘数据</div>
    <div style="border: 1px solid #d3d3d3;float:left;width:9%;height:27px;line-height:27px;text-align:center; vertical-align:middle;">迁移到</div>
    <div style="border: 1px solid #d3d3d3;float:left;width:45%;height:27px;line-height:27px;text-align:center; vertical-align:middle;">迁移目标机硬盘</div>
</div>

<div id="divharddisk" style="display:none;">
	<div id="harddisk_div">
		<div class="clear"></div>
		<div style="margin-top:10px;"></div>
		<div style="float:left;height:27px;line-height:27px;vertical-align:middle;width:45%;overflow:auto;"><input type="checkbox" name="srcharddisk"/><span id="srcharddiskname"></span></div>
		<div style="float:left;height:27px;line-height:27px;vertical-align:middle;width:9%;text-align:center; vertical-align:middle;margin-left: 3px">迁移到</div>
		<div style="float:left;height:27px;line-height:27px;vertical-align:middle;;width:45%;">
			<select id="storagedevice" name="storagedevice" style="width:100%;height:100%">
			</select>
		</div>
	</div>
</div>

<div id="downloadForm" title="更新" class="ajaxForm">
	<div style="margin-top: 10px;">下载更新文件后，请上传至服务器,服务器会立即执行更新命令</div>
    <div style="margin-top: 10px;">点击<a id="imgurl" href="" target="_blank" style="color: blue">{{ company }}在线驱动库</a>下载最新驱动包</div>
	<div style="margin-top: 10px;">点击“选择文件”按钮，选择刚下载的驱动包，然后点击“上传并更新”按钮。</div>
	<div style="margin-top: 10px;">
		<input type="file" id="localfile" />
        <div style="margin-top: 10px;" id="info"></div>
		<div class="mybtn_nav">
			<input type="button" id="uploadImg" class="myprev" style="float:right;margin-top:40px;margin-right:3px;" value="上传并更新" />
		</div>
	</div>
</div>

<div id="downloadFormFlash" title="更新" class="ajaxForm">
	<form id= "uploadForm" enctype="application/octet-stream">
	<div style="margin-top: 10px;">下载更新文件后，请上传至服务器,服务器会立即执行更新命令</div>
	<div style="margin-top: 10px;">镜像链接：<a id="imgurl2" href="" target="_blank">下载地址</a></div>
	<div style="margin-top: 10px;">
		<input type="file" id="localfileflash"/>
		<div class="clear"></div>
		<div id="info2" style="margin-top: 10px;"></div>
	</div>
	</form>
</div>

<div class="mywaite ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;position: absolute;top: 40%;left: 50%; display:none;">
	<p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
	<strong>请稍候</strong><span id="msg"></span></p>
</div>

<div id="pe-status-checking" class="my-pe-waite ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0px 1.7em;position: absolute;top: 40%;left: 50%; display:none;z-index: 9999;">
    <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
    <strong>请稍候</strong>&nbsp;正在连接目标客户端...</p>
</div>

<div style="display: none" id="RouteMatherNode">
    <div class="pre_route_cfg" style="border:1px solid #d3d3d3;margin-top:10px">
        <span style="float: right;cursor:pointer" onclick="delRouteDiv(this);">关闭</span>
        <table width="100%" border="0" cellspacing="5" cellpadding="0">
            <tr>
                <td align="right" width="20%">目标网络：</td>
                <td><input type="text" class="input" name="route_ip"  onblur="removespace(this)"/></td>
            </tr>
            <tr>
                <td align="right">网络掩码：</td>
                <td><input type="text" class="input" name="route_mask"  onblur="removespace(this)"/></td>
            </tr>
            <tr>
                <td align="right">网关：</td>
                <td><input type="text" class="input" name="route_gateway"  onblur="removespace(this)"/></td>
            </tr>
        </table>
    </div>
</div>

<div id="get_info_tmp" style="display: none">
    {% verbatim %}
    <div id="get_info">
        <h4>请确认下迁移信息：</h4>
        <p style="margin:0;padding:0;margin-left: 2em;line-height: 2em;">源主机：<span>{{ src_host }}</span></p>
        <p style="margin:0;padding:0;margin-left: 2em;line-height: 2em;">目标主机：<span>{{ dst_host }}</span></p>
        <p style="margin:0;padding:0;color:red;line-height: 2em;">提示：目标机被恢复区域的全部数据将被覆盖且不可恢复。</p>
        <p style="margin:0;padding:0;line-height: 2em;">请输入:<span style="color: red">{{ cfm_info }}</span>,
            后点击“确认”按钮执行迁移操作,或者点击“取消”按钮放弃此次操作。</p>
        <input type="text" v-model="i_value" style="margin-top: 10px;width: 500px;height: 20px" v-on:input="oninput">
    </div>
    {% endverbatim %}
</div>

{% include 'tree.inc.html' %}

<head>
    <script type="text/javascript" src="/static/js/jquery.json.js"></script>
</head>

<script type="text/javascript">
    {% include 'restore_migrate_cm.js' %}
    {% include 'driver_verison_choice_cm.js' %}
</script>

<script type="text/javascript">


function SRC_ClientDetailCallback(jsonstr, host_ident) {
	if(jsonstr.r!=0) {
		$('#show_clientname_src').html(jsonstr.e);
		return;
	}
	$('#show_clientname_src').html(jsonstr.servername);
	$('#show_pcname_src').html(jsonstr.pcname);
	$('#show_ipaddrs_src').html(jsonstr.ip);
	$('#show_macaddrs_src').html(jsonstr.mac);
	$('#show_os_type_src').html(jsonstr.os);
	$('#show_build_num_src').html(jsonstr.buildnum);
	$('#show_disk_num_src').html(jsonstr.harddisknum);
	$('#show_disk_info_src').html(jsonstr.harddiskinfo);
	$('#show_disk_total_src').html(jsonstr.total + 'GB');
	$('#show_disk_used_src').html(jsonstr.use + 'GB');
}

function src_is_linux() {
    return $('#show_os_type_src').html().toLowerCase().indexOf('linux')!=-1;
}

function TAR_ClientDetailCallback(jsonstr) {
    if(jsonstr.r!=0) {
		$('#show_clientname_tar').html(jsonstr.e);
		return;
	}
	$('#show_clientname_tar').html(jsonstr.servername);
	$('#show_pcname_tar').html(jsonstr.pcname);
	$('#show_ipaddrs_tar').html(jsonstr.ip);
	$('#show_macaddrs_tar').html(jsonstr.mac);
	$('#show_os_type_tar').html(jsonstr.os);
	$('#show_build_num_tar').html(jsonstr.buildnum);
	$('#show_disk_num_tar').html(jsonstr.harddisknum);
	$('#show_disk_info_tar').html(jsonstr.harddiskinfo);
	$('#show_disk_total_tar').html(jsonstr.total + 'GB');
	$('#show_disk_used_tar').html(jsonstr.use + 'GB');
}

function TAR_PeDetailCallback(jsonstr) {
    if (jsonstr.r != 0){
		$('#show_clientname_tar').html(jsonstr.e);
		$('#show_ipaddrs_tar').html('');
		$('#show_disk_total_tar').html('');
		$('#show_disk_num_tar').html('');
		openErrorDialog({title:'错误',html:jsonstr.e});
    }else{
        $('#show_clientname_tar').html(jsonstr.pe_name);
        $('#show_ipaddrs_tar').html(jsonstr.ip);
        $('#show_disk_total_tar').html(jsonstr.total_gb + 'GB');
        $('#show_disk_num_tar').html(jsonstr.disk_num);
    }
    $('#show_clientname_tar').html(jsonstr.pe_name);
	$('#show_pcname_tar').html('');
	$('#show_macaddrs_tar').html('');
	$('#show_os_type_tar').html('');
	$('#show_build_num_tar').html('');
	$('#show_disk_info_tar').html('');
	$('#show_disk_used_tar').html('');
}

$('#Servers_Tree1').on('acitree', function(event, api, item, eventName, options) {
	if (eventName == 'selected'){
		var itemData = api.itemData(item);
		var id=api.getId(item);
		if(id.length==32)
		{
			var params='a=srcclientinfo&id='+id;
			myAjaxGet('../migrate_handle/',params,SRC_ClientDetailCallback, id);
		}
	}
});

$('#Servers_Tree2').on('acitree', function(event, api, item, eventName, options) {
	if (eventName == 'selected'){
		var itemData = api.itemData(item);
		var id = api.getId(item);
		UnCheckAllAciTreeRadios('Servers_Tree2',id);
        var parent_id = GetAciTreeParent('Servers_Tree2', id);

        var params = 'id=' + id;
        if (parent_id == 'ui_1' && id.length == 32)
		{
				params += '&a=tarclientinfo';
                myAjaxGet('../migrate_handle/', params, TAR_ClientDetailCallback);
		}
        if (parent_id == 'ui_2' && id.length == 32)
		{
				params += '&a=tarpeclientinfo';
                myAjaxGet('../migrate_handle/', params, TAR_PeDetailCallback);
		}
	}
});

$(function() {
	$("#tabs").tabs();
	$( "#tabs" ).tabs( "option", "active", 0 );
	$("#tabs").css('min-height',570);
	$(".ui-tabs-nav").hide();
	$(".prev").hide();
	$('#navigation').html('<div class="font_navigation">迁移 > 源客户端</div>');
    var params='a=url';
    myAjaxGet('../version_handle/',params,UrlCallback);
	initAciTree('Servers_Tree1','../migrate_handle/?a=serverlist&id=');
    $('#navigation').append('<div class="help_navigation"><a href="/xdashboard/faq/#migrations" target="blank"><img src="/static/images/tip_icon_ask.png" height="24" width="24"></a></div>');
    $('#driver_version_tree').on('acitree', function(event, api, item, eventName, options) {
        // get the item ID
        //console.log(eventName);
        if (eventName == 'beforeappend'){
            $('.mywaite').hide();
        }
        if (eventName == 'loadfail'){
            $('.mywaite').hide();
            if(check_multi_version){
                $('#driver_update_method input[value=1]').click();
                check_multi_version = false;
                return ;
            }
            $('#driver_version_tree').html('未获取到匹配的驱动版本。');
            $('#driver_version_tree').height('32px');
        }
        if (eventName === 'loaded'){
            uncheck_box_of_drivers_tree($('#driver_version_tree'));
            append_choice($('#driver_version_tree'));
            append_force_install_button($('#driver_version_tree'));
        }
    });
	migrate_resize();
	$("#tabs-shell").load("../../fun_htmls/ #preBackupShellUI");
});

function setPreControlStatus(selindex)
{
	if(selindex==1)
	{
		$(".prev").hide();
	}
	$('#next').attr("value","下一步»");
}

function setControlStatus(selindex)
{
	if(selindex==2)
	{
		$('#next').val('开始迁移');
	}
}

function setNextControlStatus(selindex)
{
	if(selindex >= 6)
	{
		$('#next').val('开始迁移');
	}
	else {
	    $('#next').attr("value","下一步»");
    }
}

function show_routers_to_page(jsonstr) {
    $("#show_src_routers table").empty();
    $("#show_dest_routers table").empty();
    $('#change_dest_routes').show();
    $('#change_src_routes').show();
    if(jsonstr.src_routers == []){
        var _tr = $("<tr>").append("<th>编号</th><th>目标网络</th><th>网络掩码</th><th>网关</th>");
        var _tr1 = $("<tr>").append("<td>1</td><td>无</td><td>无</td><td>无</td>");
        $("#show_src_routers table").append(_tr).append(_tr1);
        $('#change_src_routes').hide();
    }
    else
    {
        $.each(jsonstr.src_routers, function (index, oneroute) {
             var _tr = $("<tr>").append("<th>编号</th><th>目标网络</th><th>网络掩码</th><th>网关</th>");
             var _td_index = $("<td>").html(index + 1);
             var _td_ip = $("<td>").html(oneroute[0]);
             var _td_mask = $("<td>").html(oneroute[1]);
             var _td_gateway = $("<td>").html(oneroute[2]);
             var _tr1 = $("<tr>").append(_td_index).append(_td_ip).append(_td_mask).append(_td_gateway);
             if (index == 0){
                 $("#show_src_routers table").append(_tr).append(_tr1);
             }
             else{
                  $("#show_src_routers table").append(_tr1);
             }

        });
    }
    if(jsonstr.dest_routers == []){
        var _tr = $("<tr>").append("<th>编号</th><th>目标网络</th><th>网络掩码</th><th>网关</th>");
        var _tr1 = $("<tr>").append("<td>1</td><td>无</td><td>无</td><td>无</td>");
        $("#show_dest_routers table").append(_tr).append(_tr1);
        $('#change_dest_routes').hide();
    }
    else
    {
        $.each(jsonstr.dest_routers, function (index, oneroute) {
             var _tr = $("<tr>").append("<th>编号</th><th>目标网络</th><th>网络掩码</th><th>网关</th>");
             var _td_index = $("<td>").html(index + 1);
             var _td_ip = $("<td>").html(oneroute[0]);
             var _td_mask = $("<td>").html(oneroute[1]);
             var _td_gateway = $("<td>").html(oneroute[2]);
             var _tr1 = $("<tr>").append(_td_index).append(_td_ip).append(_td_mask).append(_td_gateway);
             if (index == 0){
                 $("#show_dest_routers table").append(_tr).append(_tr1);
             }
             else{
                  $("#show_dest_routers table").append(_tr1);
             }
        })
    }
}

function GetHardDisks(jsonstr)
{
	$('div#HardDisks').html($('#divharddiskheader').html());
    $('.mywaite').hide();
	if(jsonstr.r!=0)
	{
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
	}

	if(jsonstr.replace_efi)
	{
		$('#replace_efi_div').show();
	}
	else
	{
		$('#replace_efi_div').hide();
	}

	// 目标磁盘 升序排列
	jsonstr.destlist.sort(function (a, b) {
	    if (a['bootable']){
	        return -1
        }
        if (b['bootable']){
	        return 1
        }
        return a['bytes'] - b['bytes']
    });

	// 源磁盘 升序排列
	jsonstr.srclist.sort(function (a, b) {
	    if (a['bootable']){
	        return -1
        }
        if (b['bootable']){
	        return 1
        }
        return a['bytes'] - b['bytes']
    });
	var selected_index = [];

	$.each(jsonstr.srclist, function(i, item){
		var harddisk_divname="harddisk_div"+(i+1);
		var html=$('div#divharddisk').html().replace("harddisk_div",harddisk_divname);
		$('div#HardDisks').append(html);

		if(item.bootable){
			$('div#'+harddisk_divname+' input[name="srcharddisk"]').attr('checked','checked').attr('onclick', 'return false').attr('value', item.id+'|'+item.totalsize).addClass('isbootable');;
			srcdiskname = '(引导盘)'+'('+item.totalsize+'GB)'+item.name;
			$('div#'+harddisk_divname+' #srcharddiskname').html(srcdiskname);
			for(var i=0;i<jsonstr.destlist.length;i++) {
                if (jsonstr.destlist[i].bootable){
					var tmphtml = '<option value="{disk_id}|{disk_size}" selected="selected" class="isbootable">{disk_name}</option>';
				    selected_index.push(i);
                }
                else{
                    var tmphtml = "<option value='{disk_id}|{disk_size}'>{disk_name}</option>";
                }
                tmphtml = tmphtml.replace('{disk_size}',jsonstr.destlist[i].totalsize);
                tmphtml = tmphtml.replace('{disk_id}',jsonstr.destlist[i].id);
                tmphtml = tmphtml.replace('{disk_name}', jsonstr.destlist[i].name);
                tmphtml = set_html_elem_title_prop(tmphtml, jsonstr.destlist[i].disk_sn);
                $('div#' + harddisk_divname + ' #storagedevice').append(tmphtml);
            }
		}
		else{
			$('div#'+harddisk_divname+' input[name="srcharddisk"]').val(item.id+'|'+item.totalsize);
			srcdiskname = '('+item.totalsize+'GB)'+item.name;
			$('div#'+harddisk_divname+' #srcharddiskname').html(srcdiskname);
			var has_find = false;
			for(var i=0;i<jsonstr.destlist.length;i++){
			    var is_big = parseFloat(jsonstr.destlist[i].totalsize) >= parseFloat(item.totalsize);
                var not_bootable = !jsonstr.destlist[i].bootable;
                var not_use = selected_index.indexOf(i)==-1;
                if (not_bootable && not_use && is_big && !has_find){
			        var tmphtml = '<option value="{disk_id}|{disk_size}" selected="selected" >{disk_name}</option>';
					selected_index.push(i);
					has_find = true;
                }else {
			        var tmphtml = "<option value='{disk_id}|{disk_size}'>{disk_name}</option>";
                }
				tmphtml = tmphtml.replace('{disk_id}',jsonstr.destlist[i].id);
				tmphtml = tmphtml.replace('{disk_name}', jsonstr.destlist[i].name);
				tmphtml = tmphtml.replace('{disk_size}', jsonstr.destlist[i].totalsize);
				tmphtml = set_html_elem_title_prop(tmphtml, jsonstr.destlist[i].disk_sn);
				$('div#' + harddisk_divname + ' #storagedevice').append(tmphtml);
			}
		}

		if(!item.is_support){
		    $('div#'+harddisk_divname+' input[name="srcharddisk"]').prop('checked', false).prop('disabled', true);
        }
	});
}

function MigrateCallback(jsonstr)
{
    $('.mywaite').hide();
	if(jsonstr.r!=0)
	{
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
	}
	$(".prev").hide();
	$('#next').attr("value","下一步»");
	$("#tabs").tabs();
	$( "#tabs" ).tabs( "option", "active", 0 );
	var html='已开始执行移迁<br />您可在<a href="../home" style="color:blue;">系统状态</a>中查看迁移执行情况，或在<a href="../serverlog" style="color:blue;">客户端日志</a>中查看详细信息。';
	openSuccessDialog({title:'成功',html:html});
}

function isRepeat(arr)
{
	var hash = {};

	for(var i in arr)
	{
		if(hash[arr[i]])
			return true;
		hash[arr[i]] = true;
	}
	return false;
}

function CheckDisks(disks)
{
	var destdisk = new Array();
	for(var i=0;i<disks.length;i++)
	{
		destdisk.push(disks[i].dest);
	}

	if( isRepeat(destdisk) )
	{
		openErrorDialog({title:'错误',html:'多个源硬盘不能迁移到同一目标硬盘'});
		return false;
	}

	return true;
}

function StartMigrate(other_params)
{
	var serverid=getaciTreeChecked('Servers_Tree1');
	var params='srcserverid='+serverid;
	var destserverid='none';
	destserverid=getaciTreeChecked('Servers_Tree2');
	var tmpid=GetAciTreeParent('Servers_Tree2',destserverid);
	if(tmpid=='ui_1')
	{
		destserverid=GetAciTreeValue('Servers_Tree2',destserverid,'peserverid');
	}
	params+='&destserverid='+destserverid;
    var router_list = []
    var routers = {"is_save":1,"router_list":router_list};
    acquire_routers(router_list, routers);
    params += "&routers=" + JSON.stringify(routers);
	params+="&adapters=" + encodeURIComponent(JSON.stringify(g_adapter_list));
	var disks=new Array();
	for(var i=0;i<$('div#HardDisks').children('div').length;i++)
	{
		var divdisk=$('div#HardDisks').children('div')[i].id;
		if(divdisk && $('div#'+divdisk+' input[name="srcharddisk"]').prop("checked"))
		{
			var diskjson={};
			var src=$('div#'+divdisk+' input[name="srcharddisk"]').val().split('|');
			var dest=$('div#'+divdisk+' #storagedevice').val().split('|');
			var a=new Num64(src[1]);
			var b=new Num64(dest[1]);
			if( a.compare(b) == 1 )
			{
				var disk = {ident:src[0],
                    src_name:$('div#'+divdisk+' #srcharddiskname').text(),
                    dst_name:$('div#'+divdisk+' #storagedevice option:selected').text(),
                    value:((parseFloat(src[1])-parseFloat(dest[1]))).toFixed(2)+'GB'
                }
                var error = disk_checker.check(disk);
                if (error){
                    openWarningDialog({title:'警告',html:error,width:550,height:250});
                    //unlock_btns();
                    return ;
                }
			}

			diskjson.src=src[0];
			diskjson.dest=dest[0];
			disks.push(diskjson);
		}
	}

	if( !CheckDisks(disks) )
	{
		return;
	}

	params+="&disks="+JSON.stringify(disks);
	params+="&a=startmigrate";
    var drivers_ids = '';
    var drivers_type = '1';
    var drivers_ids_force = '';
    if($('input[name=choice_method]:checked').val() ==2){
        drivers_ids = getAciTreeBoxChecked('driver_version_tree');
        drivers_ids_force = getaciTreeChecked('driver_version_tree');
        drivers_type = '2';
    }
    params+="&drivers_ids="+encodeURIComponent(drivers_ids)+'&drivers_type='+drivers_type;
    params+="&drivers_ids_force="+encodeURIComponent(drivers_ids_force);
    params+="&thread_count=" + $('input#thread-count').val();

    params+=other_params;
    params+='&disable_fast_boot='+!vm_fast_restore.checked;
	params+="&replace_efi="+$('#replace_efi').is(':checked');
    if ( is_no_bootable_to_bootable_disk()){
        openConfirmDialog({
		title:'确认信息',
        width: 500,
		height: 250,
		html:'&nbsp;&nbsp;&nbsp;&nbsp;检测到快照中的引导盘迁移到目标主机的非引导盘，当迁移完成目标主机重启时，可能无法进入恢复后的系统。<br>&nbsp;&nbsp;&nbsp;&nbsp;点击确定执行此操作，迁移完成后，请进入BIOS配置，将当前选择的目标硬盘设置为启动硬盘。<br>&nbsp;&nbsp;&nbsp;&nbsp;点击取消，放弃此次操作。',
		onBeforeOK:function(){
			$(this).dialog('close');
            $('#msg').html('正在执行迁移任务。');
            $('.mywaite').show();
			myAjaxPost('../migrate_handle/',params,MigrateCallback);
            return;
		    }
	    });
    }
    else{
        $('#msg').html('正在执行迁移任务。');
        $('.mywaite').show();
        myAjaxPost('../migrate_handle/',params,MigrateCallback);
    }
}

function acquire_routers(router_list, routers){
    if($("input[name=choice_routers]:checked").val()=="1"){ //源路由
        routers['is_save'] = 0;
        get_all_routes_src(router_list);
    }
    else{ //目标路由
        routers['is_save'] = 0;
        get_all_routes_dest(router_list);
    }
}

function is_no_bootable_to_bootable_disk() {
    for(var i=0;i<$('div#HardDisks').children('div').length;i++)
	{
		var divdisk=$('div#HardDisks').children('div')[i].id;
		if(divdisk && $('div#'+divdisk+' input[name="srcharddisk"]').prop("checked"))
		{
			var src=$('div#'+divdisk+' input[name="srcharddisk"]').hasClass('isbootable');
			var dest=$('div#'+divdisk+' #storagedevice option:selected').hasClass('isbootable');
            if((src==true) && (dest==false)){
                return true;
            }

		}
	}
    return false;
}

// 迁移提示信息：源主机、目标主机
function get_init_vue_data() {
    // 源主机名称
    var data = {};
    data.src_host = getaciTreeNameChecked('Servers_Tree1')

    // 目标机
    var targetName = getaciTreeNameChecked('Servers_Tree2');
    data.dst_host = targetName.split(')(')[0];

    var ip_matcher = data.dst_host.match(/(?:\d+\.){3}(?:\d+)/);
    data.cfm_info = ip_matcher ? ip_matcher[0] : Math.random().toString(36).substr(2, 6).toUpperCase();
    data.i_value = '';
    return data;
}

function open_cfm_dialog(other_params) {
    $('#get_info_tmp').dialog({
        title: '确认信息',
        autoOpen: true,
        modal: true,
        width: 550,
        height: 350,
        buttons: [
            {
                text: '确认',
                click: function () {
                    $(this).dialog('close');
                    StartMigrate(other_params);
                },
                id: 'get_info_tmp_cfm'
            },
            {
                text: '取消',
                click: function () {
                    $(this).dialog('close');
                },
            }
        ]
    });
}

function OnFinish(other_params)
{
    vue_i1.init(get_init_vue_data());
    open_cfm_dialog(other_params);
    vue_i1.oninput();
}

$('#prev').click(function() {
    if($('.mywaite').is(":visible"))
	{
		return;
	}
	var selindex=$("#tabs").tabs('option', 'active');
    clearInterval(rt_t1);
	if(selindex==1)
	{
		$('#navigation').html('<div class="font_navigation">迁移 > 源客户端</div>');
	}
	else if(selindex==2)
	{
		var f1 = $('#check_left td').hasClass('status_waiting_fonts');
		if (f1){ //正在进行任务，不可以跳转。
		    return;
        }
	}
	else if(selindex==5)
	{
		$('#navigation').html('<div class="font_navigation">迁移 > 源客户端 > 目标机 > 目标机IP</div>');
	}
	if(selindex==0)
	{
	}
	if(selindex == 4){
	    if(g_same){
	        $( "#tabs" ).tabs( "option", "active", selindex-2 );
	        return;
        }
        else{
	        $( "#tabs" ).tabs( "option", "active", selindex-1 );
	        return;
        }
    }
    if(selindex == 5){
	    if(src_is_linux()){
	        $( "#tabs" ).tabs( "option", "active", selindex-3);
        }else {
	        $( "#tabs" ).tabs( "option", "active", selindex-1);
        }
    }
	else
	{
		$("#tabs").tabs();
		$( "#tabs" ).tabs( "option", "active", selindex-1 );
		setPreControlStatus(selindex);
	}
});

$('#RefreshSrcServer').button().click(function(){
	RefreshAciTree("Servers_Tree1",'../migrate_handle/?a=serverlist&id=');
});

$('#RefreshdestServer').button().click(function(){
	RefreshAciTree("Servers_Tree2",'../migrate_handle/?a=destserverlist&id=');
});

function SetAciTreeValue(treeid,id,key,value)
{
	var api = $('#'+treeid).aciTree('api');
	var parentid='none';
	var children=api.children(null, true, true);
	var ids='';
	api.radios(children).each(api.proxy(function(element) {
		var item = $(element);
		if(id == this.getId(item))
		{
			this.itemData(item)[key]=value;
			return false;
		}

	}, true));

}

function GetAciTreeValue(treeid,id,key)
{
	var api = $('#'+treeid).aciTree('api');
	var parentid='none';
	var children=api.children(null, true, true);
	var value='';
	api.radios(children).each(api.proxy(function(element) {
		var item = $(element);
		if(id == this.getId(item))
		{
			value=this.itemData(item)[key];
			return false;
		}

	}, true));

	return value;

}
var g_same = false;
function GetServerId(jsonstr)
{
	if(jsonstr.r!=0)
	{
	    $( "#tabs" ).tabs( "option", "active", 0 );
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
	}
	SetAciTreeValue('Servers_Tree2',jsonstr.serverid,'peserverid',jsonstr.destserverid);
	if (src_is_linux()){
        change_to_checked(1,'已分配');
    }else {
	    change_to_waiting(2, '已分配');
	    check_is_same(jsonstr.destserverid);
    }
}

function check_is_same(t_id) {
    var params="serverid="+t_id;//pe ident
	var pointid=getaciTreeChecked('Servers_Tree1');
	params+='&pointid='+pointid;
	myAjaxGet('../restore_handle/?a=check_is_same_computer&need_check_local_db=1',params,check_is_same_call_back, t_id);
}

function check_is_same_call_back(jsonstr, t_id) {
    if (jsonstr.r != 0){
        $( "#tabs" ).tabs( "option", "active", 0 );
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
    }
    if (jsonstr.restore_to_self){
        $('#step2').attr('data-restore-to-self', '1');
    }else{
        $('#step2').attr('data-restore-to-self', '0');
    }
    if (jsonstr.is_same == 0){
        change_to_checked(2, '同构');
        g_same = true;
        return;
    }
    else{
        change_to_waiting(3,'异构');
        CheackAgentOrPeDriver(t_id);
    }
}

function CheackAgentOrPeDriver(t_id) {
    var params="serverid="+t_id;//pe ident
	var pointid=getaciTreeChecked('Servers_Tree1');
	params+='&pointid='+pointid;
	myAjaxGet('../restore_handle/?a=checkpedriver',params,checkagentorpedriver);
}

function checkagentorpedriver(jsonstr)
{
	if(jsonstr.r!=0)
	{
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
	}
	if(jsonstr.update==1)
	{
	    var strs = '发现{}个硬件未匹配到驱动'.replace('{}', jsonstr.list.length);
        change_to_waiting(4, strs);
		$('#errinfo2').html('');
		update_driver_info(false, '');
		ShowDriverList(jsonstr);
	}
	else
	{
        g_same = true;
        change_to_checked(3, '完全匹配');
	}
}

function CheckData(selindex)
{
	if(selindex==0)
	{
		if (getaciTreeChecked('Servers_Tree1')=='')
		{
			openErrorDialog({title:'错误',html:"请选择需要迁移的客户端"});
			return false;
		}
	}
	else if(selindex==1)
	{
		if (getaciTreeChecked('Servers_Tree2')=='')
		{
			openErrorDialog({title:'错误',html:"请选择客户端"});
			return false;
		}

		if (getaciTreeChecked('Servers_Tree1')==getaciTreeChecked('Servers_Tree2'))
		{
			openErrorDialog({title:'错误',html:"源和目标客户端不能相同"});
			return false;
		}
	}
	else if(selindex==5)
	{
		return check_and_update_g_adapter_list();
	}
	else if(selindex==7){
	    var tabsShell$ = $('#tabs-shell');
		var shell_infos = get_shell_infos_from_ui(tabsShell$);

        if(is_enable_shell(tabsShell$)){
			if(shell_infos.exe_name === ''){
				openErrorDialog({title:'错误', html:'可执行文件名: 不能为空'});
				return false;
			}
			if(shell_infos.work_path === ''){
				openErrorDialog({title:'错误', html:'执行路径: 不能为空'});
				return false;
			}
			if(shell_infos.unzip_path === ''){
				openErrorDialog({title:'错误', html:'解压路径: 不能为空'});
				return false;
			}

            if(shell_infos.zip_file === ''){
                openErrorDialog({title:'错误', html:'.zip/.tar.gz: 不能为空'});
                return false;
            }
		}
    }
    else if(selindex==6){
	    if(!is_positive_num_and_in_range($('input#thread-count').val(), '2', '8')){
            openErrorDialog({title:'错误', html:'**迁移源存储读取队列深度**  \n输入无效, 请重新输入'});
            return false;
        }
    }

	return true;
}

var driver_info = {'is_no_driver':false, 'os':''};
function update_driver_info(is_no_driver, os){
    driver_info = {'is_no_driver':is_no_driver, 'os':os};
    $('#os_info').text(os);
}

function is_no_driver() {
    return driver_info['is_no_driver']
}

function notify_no_driver() {
    var msg = '发现有未匹配的驱动，继续操作可能导致目标机无法启动。点击“确定”忽略此次警告，继续任务；点击“取消”关闭此对话框。';
    var msg1 = '请联系超级管理员下载操作系统：[' + '<span style="color:red">'+ driver_info['os'] +'</span>' + ']的驱动，更新至{{ title }}后，再次进行操作。';
    var p = $('<p style="text-indent:2em"></p>').html(msg);
    var p1 = $('<p style="text-indent:2em;margin-top:5px;"></p>').html(msg1);
    var html = $('<div></div>').append(p).append(p1);
    openConfirmDialog({
        title: '警告',
        html: html,
        height: 300,
        width:600,
        onBeforeOK: function () {
            $(this).dialog('close');
            $("#tabs").tabs("option", "active", 4);
        },
        onCancel: function () {
            return;
        }
    });
}

function toRunIndex1() {
    $('#navigation').html('<div class="font_navigation">迁移 > 源客户端 > 目标机 > 目标机IP</div>');
    var destserverid='none';
    g_same=false;
    has_set_interval=false;
    change_all_to_todo();
    destserverid=getaciTreeChecked('Servers_Tree2');
    var tmpid=GetAciTreeParent('Servers_Tree2',destserverid);
    if(tmpid=='ui_1')
    {
        change_to_waiting(1);
        params="a=getserverid&agentserverid="+destserverid;
        myAjaxGet('../migrate_handle/',params,GetServerId);
    }
    else
    {
        if (src_is_linux()){ // 源是linux,  不走驱动检测与匹配的流程！
            change_to_checked(1,'已分配');
        }else{
            change_to_waiting(2,'已分配');
            CheckPEDriver();
        }
    }
}

var disk_checker = new DiskCheck();

$('#next').click(function() {
    if($('.mywaite').is(":visible"))
	{
		return;
	}
    if(isShowedCheckingPeMsg()){
        return;
    }

	var selindex=$("#tabs").tabs('option', 'active');
    $(".prev").show();
    clearInterval(rt_t1);
	if(!CheckData(selindex))
	{
		return;
	}

    if(selindex === 1 && isTargetPe('Servers_Tree2')){
        disk_checker.init();
        checkingPeStatus($("#tabs"), selindex + 1, getaciTreeChecked('Servers_Tree2'), toRunIndex1);
        setNextControlStatus(selindex);
        return;
    }

	if(selindex==0)
	{
		$('#navigation').html('<div class="font_navigation">迁移 > 源客户端 > 目标机</div>');
		RefreshAciTree("Servers_Tree2",'../migrate_handle/?a=destserverlist&id=');
		$('#driver_update_method input[value=1]').click();
	}
	else if(selindex==1)
	{
		toRunIndex1();
		disk_checker.init();
	}
	else if(selindex==2)
	{
		var f1 = $('#check_left td').hasClass('status_waiting_fonts');
		var trs = $('#check_left tr');
		var re = /\(/;
		if (f1){ //正在进行任务，不可以跳转。
		    return;
        }
        else{
		    $.each(trs, function (index, item) {
            var td_html = $(item).children().last().html();
            var rs = re.exec(td_html);
            if (rs != null){
                $(item).children().last().html(td_html.slice(0,rs.index)); //去掉后面的计时括号
                }
            })
            if (src_is_linux()){
                $("#tabs").tabs("option", "active", 5);
                init_tab5();
                return;
            }
		    if (g_same){ //是相同平台，跳转到 4
		        $( "#tabs" ).tabs( "option", "active", 4 );
		        return;
            }
            else {
		        $( "#tabs" ).tabs( "option", "active", 3 );
		        return;
            }
        }
	}
    else if(selindex==3)
	{
		var driverfileid=getAciTreeBoxChecked('drivers_Tree');
		if(driverfileid)
		{
		    var content = $('<div></div>');
		    var p = $('<p style="text-indent:2em"></p>').text('在"{{ company }}在线驱动库"中找到与迁移目标机硬件匹配的驱动，点击"导入驱动"按钮，做驱动更新。');
		    var p1 = $('<p></p>').html('注：<span style="color:red">如果放弃驱动导入，迁移后目标机可能无法启动。</span>');
			content.append(p).append(p1)
		    openConfirmDialog({
				title:'导入驱动',
				html:content,
				height:270,
				width:500,
				confirm_text:'导入驱动',
				onBeforeOK:function(){
					myupdate();
					$(this).dialog('close');
				},
				onCancel:function(){
                    $( "#tabs" ).tabs( "option", "active", 4 );
					return;
				}
			});
			return;
		}
		if (is_no_driver()){
		     notify_no_driver();
		    return;
        }
	}
	else if(selindex==4)
	{
	    if ($('#driver_update_method input:checked').val() == 2){
			var ret = has_choice_driver();
			if(ret.r!=0)
			{	var html = '设备';
				html += ret.driverAray.join(',');
				html += '没有勾选对应的驱动！你确定忽略吗?';
				openConfirmDialog({
					title:'确认信息',
					html:html,
					onBeforeOK:function(){
						init_tab5();
						$( "#tabs" ).tabs( "option", "active", selindex+1 );
						setNextControlStatus(selindex);
						$(this).dialog('close');
					}
				});
				return;
			}
        }
        init_tab5();
        $( "#tabs" ).tabs( "option", "active", selindex+1 );

	}
    if(selindex==5)
        {
            //params="srcserverid="+$('#selservername').val();
            var srcserverid=getaciTreeChecked('Servers_Tree1');
            params="srcserverid="+srcserverid;
            var destserverid=getaciTreeChecked('Servers_Tree2');
            var tmpid=GetAciTreeParent('Servers_Tree2',destserverid);
            if(tmpid=='ui_1')
            {
                destserverid=GetAciTreeValue('Servers_Tree2',destserverid,'peserverid');
            }
            $('#msg').html('正在获取硬盘信息。');
            $('.mywaite').show();
            params+="&destserverid="+destserverid;
            myAjaxGet('../migrate_handle/?a=harddisksettings',params,GetHardDisks);
        }

    if(selindex==6){
        if (!check_disk_migrate()){
            return;
        }
        init_shell_infos_from_ui($('#tabs-shell'));
    }

    if(selindex==7){
        if(is_enable_shell($('#tabs-shell'))){
            uplodePreBackupShell($('#preBackupShell'), '../hotbackup_handle/?a=upload_script', uplodeCallbkMgr);
        }
        else {
            OnFinish('');
        }
    }
	else
    {
        $( "#tabs" ).tabs( "option", "active", selindex+1 );
    }

    setNextControlStatus(selindex);
});

    function UrlCallback(jsonstr)
    {
	if(jsonstr.r!=0)
	{
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
	}
	jsonstr.url = window.location.protocol + "//" + jsonstr.url;
	$('#aiourl').val(jsonstr.url);
    }

    function ShowDriverList(jsonstr)
    {
        RefreshAciTree("drivers_Tree",null,ShowDriverTree,jsonstr);
    }

    function CheckPEDriver()
    {

        var destserverid=getaciTreeChecked('Servers_Tree2');
        var tmpid=GetAciTreeParent('Servers_Tree2',destserverid);
        if(tmpid=='ui_1')
        {
            destserverid=GetAciTreeValue('Servers_Tree2',destserverid,'peserverid');
        }
        check_is_same(destserverid);
    }

    function checkpedriver(jsonstr)
    {
        $('.mywaite').hide();
        if(jsonstr.r!=0)
        {
            openErrorDialog({title:'错误',html:jsonstr.e});
            return;
        }
        if(jsonstr.update==1)
        {
            $( "#tabs" ).tabs( "option", "active", 2 );
            $('#errinfo2').html('');
            ShowDriverList(jsonstr);
        }
        else
        {
            //$('#msg').html('正在获取网卡信息。');
            //$('.mywaite').show();
            //$( "#tabs" ).tabs( "option", "active", 3 );
            //params="serverid="+getaciTreeChecked('Servers_Tree2');
            //params+="&needadapterset=0";
            //myAjaxGet('../restore_handle/?a=adaptersettings',params,GetAdapters);
            g_same=true;
            $( "#tabs" ).tabs( "option", "active", 3 );
        }
    }

    function myupdate()
    {
        var driverfileid=getAciTreeBoxChecked('drivers_Tree');
        var url = $('#aiourl').val()+'/index.php/api/drivers/?a=getdownload&ids='+driverfileid;
        $('#msg').html('正在生成驱动压缩包，这可能需要几分钟的时间。');
        $('.mywaite').show();
        myJsonp(url,'errinfo2',getdownloadCallback,null,10*60*1000);
    }

    function getdownloadCallback(jsonstr)
    {
        $('.mywaite').hide();
        if(jsonstr.r!=0)
        {
            openErrorDialog({title:'错误',html:jsonstr.e});
            return;
        }
        var url = jsonstr.url;
        $('#imgurl').attr('href',url);
        $('#imgurl2').attr('href',url);
        var formid='downloadForm';
        var height = 320;
        if (!window.FileReader)
        {
            var head = document.getElementsByTagName('head')[0];
            var link = document.createElement('link');
            link.href = '/static/js/uploadify/uploadify.css';
            link.rel = 'stylesheet';
            link.type = 'text/css';
            head.appendChild(link);

            formid='downloadFormFlash';
            height = 250;
            $.getScript('/static/js/uploadify/jquery.uploadify.min.js',function(){
                $('#localfileflash').uploadify({
                    'formData'     : {
                        'csrfmiddlewaretoken' : $.cookie('csrftoken')
                    },
                    'swf'      : '/static/js/uploadify/uploadify.swf',
                    'uploader' : '../version_handle/?a=uploadbyflash',
                    'multi'    : false,
                    'auto': true,
                    'buttonText': '选择并上传镜像文件'
                });
            });
        }
        $("#"+formid).attr('title','更新').dialog({
            autoOpen: true,
            height: height,
            width: 420,
            modal: true,
            close: function(){
            }
        });
    }

    function ShowDriverTree(jsonstr)
    {
        var api = $('#drivers_Tree').aciTree('api');

        for(i=0;i<jsonstr.list.length;i++)
        {

            var Inode={
                id:'ui_'+i,
                label:jsonstr.list[i].hardware,
                icon:'adapter',
                inode: false,
                hardid:jsonstr.list[i].id,
                compatibleid:jsonstr.list[i].compatible,
                os:jsonstr.list[i].windows,
                open:false};

            api.append(null,{itemData:Inode,
                success: function(item, options) {
                    var id=options.itemData.id;
                    var hardid=options.itemData.hardid;
                    var compatibleid=options.itemData.compatibleid;
                    var os=options.itemData.os;
                    SearchDriver(id,hardid,compatibleid,os);
                }
            });
        }
    }

    function SearchDriver(node_id,hardids,compatibleids,os)
    {
        var ids = hardids.concat(compatibleids);
        ids.sort(function(a,b){
                return a.length-b.length;
        });
        if( ids.length > 0 )
        {
            var p={
                org_ids:ids.concat(),
                node_id:node_id,
                ids:ids,
                os:os
            };
            var url =$('#aiourl').val()+'/index.php/api/drivers/?a=search&id='+encodeURIComponent(p.ids.pop())+'&os='+encodeURIComponent(p.os);
            myJsonp(url,'errinfo2',SearchDriverCallback,p,30*1000);
        }
    }

    function SearchDriverCallback(jsonstr,p)
    {
        if (!has_set_interval){
            change_to_checked(4,'查询完成');
        }
        if(jsonstr.r!=0)
        {
            openErrorDialog({title:'错误',html:jsonstr.e});
            return;
        }
        var node_id=p.node_id;
        var Inode=getInode('drivers_Tree',node_id);
        if( Inode == null)
        {
            return;
        }
        var api = $('#drivers_Tree').aciTree('api');
        if( jsonstr.list.length > 0 )
        {
            for(var i=0;i<jsonstr.list.length;i++)
            {
                var id = jsonstr.list[i].id;
                var name = jsonstr.list[i].name+'('+jsonstr.id+')';
                var checked=false;
                if(i==0)
                {
                    checked = true;
                }
                var newitem=NewItem(id,name,true,checked);
                api.append(Inode,{itemData:newitem,
                        success: function() {
                            this.open(Inode);
                        }
                    }
                );
            }
            return;
        }
        if( p.ids.length > 0 )
        {
            var url =$('#aiourl').val()+'/index.php/api/drivers/?a=search&id='+encodeURIComponent(p.ids.pop())+'&os='+encodeURIComponent(p.os);
            myJsonp(url,'errinfo2',SearchDriverCallback,p,30*1000);
        }
        else
        {
            //没有匹配成功
            update_driver_info(true, p.os);
            p.org_ids.sort(function(a,b){
                return b.length-a.length;
            });
            var label=api.getLabel(Inode);
            api.setLabel(Inode,{label: label+'<span style="color:red;">(未匹配)</span>'});
            for(var i=0;i<p.org_ids.length;i++)
            {
                var api = $('#drivers_Tree').aciTree('api');
                var id = p.org_ids[i];
                var name = p.org_ids[i];
                var checked=false;
                var newitem=NewItem(id,name,false,checked);
                api.append(Inode,{itemData:newitem,
                        success: function() {
                            //this.open(Inode);
                        }
                    }
                );
            }
        }
    }

    function getInode(treeid,id)
    {
        var api = $('#'+treeid).aciTree('api');

        var Inode = null;
        var children=api.children(null, true, true);
        children.each(api.proxy(function(element) {
            var item = $(element);
            var tmpid=this.getId(item);
            if(id==tmpid)
            {
                Inode=api.itemFrom(item);
                api.setInode(Inode,{inode:true});
                return false;
            }
        }, true));

        return Inode;
    }

    function NewItem(id,label,radio,checked)
    {
        var itemData = {
            id:id,
            label:label,
            icon:'adapter',
            checkbox:radio,
            checked:checked,
            inode: false
        };
        return itemData;
    }

    $('#driver_update_method input[value=2]').click(function () {

        var pointid=$('#pointid').val();
        var destserverid=getaciTreeChecked('Servers_Tree2');
        var tmpid=GetAciTreeParent('Servers_Tree2',destserverid);
        if(tmpid=='ui_1')
        {
            destserverid=GetAciTreeValue('Servers_Tree2',destserverid,'peserverid');
        }

        var params="destserverid="+destserverid;

        params+="&pointid="+getaciTreeChecked('Servers_Tree1');
        $('#driver_version_tree').html('');
        RefreshAciTree("driver_version_tree",'../restore_handle/?a=get_driver_version&'+params, initCallback);
        $('#msg').text('获取驱动版本中');
        $('.mywaite').show();
    })

    function initCallback() {
        $('#choice2_warp').show();
    }

    $('#driver_update_method input[value=1]').click(function () {
        $('#choice2_warp').hide();
        $('.mywaite').hide();
    })

    function delRouteDiv(spanobj) {
        $(spanobj).parent().remove();
    }

    function check_route_is_valid(jqeuryobj){
        var v1 = jqeuryobj.find('input[name=route_ip]').val();
        var v2 = jqeuryobj.find('input[name=route_mask]').val();
        var v3 = jqeuryobj.find('input[name=route_gateway]').val();
        return isIPV4(v1) && isIPV4(v2) && isIPV4(v3)
    }
    $("input[name=choice_routers]").click(function () {
    if( $(this).val() == 1){
        $('#show_src_routers').show();
        $('#show_src_routers').siblings().hide();

    }
    else{
        $('#show_dest_routers').show();
        $('#show_dest_routers').siblings().hide();
    }

    });

$('#add_src_routes').click(function () {
    var last_div = $('#src_routes_cfg .pre_route_cfg:visible').last();
    if (!check_route_is_valid(last_div)){
        openWarningDialog({title:'网络配置无效',html:'当前路由配置无效 <br>请正确配置后重试'});
        return;
    }
    var new_html = $('#RouteMatherNode').html();
    $('#src_routes_cfg').append(new_html);
});

$('#add_dest_routes').click(function () {
    var last_div = $('#dest_routes_cfg .pre_route_cfg:visible').last();
    if (!check_route_is_valid(last_div)){
        openWarningDialog({title:'网络配置无效',html:'当前路由配置无效 <br>请正确配置后重试'});
        return;
    }
    var new_html = $('#RouteMatherNode').html();
    $('#dest_routes_cfg').append(new_html);
});

function delRouteDiv(spanobj) {
    $(spanobj).parent().remove();
}

function check_route_is_valid(jqeuryobj){
    var v1 = jqeuryobj.find('input[name=route_ip]').val();
    var v2 = jqeuryobj.find('input[name=route_mask]').val();
    var v3 = jqeuryobj.find('input[name=route_gateway]').val();
    return isIPV4(v1) && isIPV4(v2) && isIPV4(v3)
}

function get_all_routes_src(routes) {
    $('#src_routes_cfg .pre_route_cfg').each(function () {
        if (!check_route_is_valid($(this))){
            return;
        }
        var one_route = {};
        one_route.route_ip = $(this).find('input[name=route_ip]').val();
        one_route.route_mask = $(this).find('input[name=route_mask]').val();
        one_route.route_gateway = $(this).find('input[name=route_gateway]').val();
        routes.push(one_route);
    });
}

function get_all_routes_dest(routes) {
    $('#dest_routes_cfg .pre_route_cfg').each(function () {
        if (!check_route_is_valid($(this))){
            return;
        }
        var one_route = {};
        one_route.route_ip = $(this).find('input[name=route_ip]').val();
        one_route.route_mask = $(this).find('input[name=route_mask]').val();
        one_route.route_gateway = $(this).find('input[name=route_gateway]').val();
        routes.push(one_route);
    });
}

function show_routers_to_page(jsonstr) {
    $("#src_routes_cfg div:gt(0)").remove();
    $("#dest_routes_cfg div:gt(0)").remove();
    $("#src_routes_cfg div:first input").val();
    $("#dest_routes_cfg div:first input").val();
    $.each(jsonstr.src_routers, function (index, oneroute) {
        if (index == 0) {
            var first_div = $("#src_routes_cfg div:first");
            first_div.find('input[name=route_ip]').val(oneroute[0]);
            first_div.find('input[name=route_mask]').val(oneroute[1]);
            first_div.find('input[name=route_gateway]').val(oneroute[2]);
        }
        else {
            var new_html = $('#RouteMatherNode').html();
            $('#src_routes_cfg').append(new_html);
            var last_div = $('#src_routes_cfg div').last();
            last_div.find('input[name=route_ip]').val(oneroute[0]);
            last_div.find('input[name=route_mask]').val(oneroute[1]);
            last_div.find('input[name=route_gateway]').val(oneroute[2]);
        }
    });
    $.each(jsonstr.dest_routers, function (index, oneroute) {
        if (index == 0) {
            var first_div = $("#dest_routes_cfg div:first");
            first_div.find('input[name=route_ip]').val(oneroute[0]);
            first_div.find('input[name=route_mask]').val(oneroute[1]);
            first_div.find('input[name=route_gateway]').val(oneroute[2]);
        }
        else {
            var new_html = $('#RouteMatherNode').html();
            $('#dest_routes_cfg').append(new_html);
            var last_div = $('#dest_routes_cfg div').last();
            last_div.find('input[name=route_ip]').val(oneroute[0]);
            last_div.find('input[name=route_mask]').val(oneroute[1]);
            last_div.find('input[name=route_gateway]').val(oneroute[2]);
        }
    });
}

function FmtSize(size)
{
	return (size/(1024*1024)).toFixed(2);
}

function UploadCallback(jsonstr)
{
	if(jsonstr.r==200)
	{
		$('#downloadForm').dialog('close');
		return;
	}
	if(jsonstr.r!=0)
	{
		openErrorDialog({title:'错误',html:jsonstr.e});
		return;
	}
	var file = $('#localfile').get(0).files[0];
	var start=jsonstr.start;
	var total = file.size;
	var html= '<div>' + '上传进度：' + FmtSize(start)+"/"+FmtSize(total)+'（MB）' + '</div>';
	html += '<div style="margin-top:10px;">上传过程中，请勿关闭或刷新浏览器。</div>';
	$('#info').html(html);
	if(start<total)
	{
		FileReaderReadFile(file,start,1024*1024);
	}
}

function FileReaderReadFile(file,start,step)
{
	var reader = new FileReader();
	var buffer = null;
	var total = file.size;
	reader.onload = function(e)
	{
		buffer=e.target.result;
	}
	reader.onloadend = function(e)
	{
		var url='../restore_handle/?a=upload';
		url+='&type=FileReader';
		url+='&name='+file.name;
		url+='&start='+start;
		url+='&step='+1024*1024;
		url+='&total='+total;
		url+='&sync='+1; // 同步1 异步0
		myPostBinary(url,buffer,UploadCallback);
	}
	//var slicer = fileOrBlob.slice || fileOrBlob.mozSlice || fileOrBlob.webkitSlice;
	var blob = file.slice(start,start+step);
	reader.readAsDataURL(blob);
}

$('#uploadImg').click(function(){
	//html5
	var file = $('#localfile').get(0).files[0];
	FileReaderReadFile(file,0,1024*1024);
});
function change_to_waiting(id, result) {
    var obj = $('#step' + id);
    var childs = obj.children();
    $(childs[0]).attr('class','status_waiting_icon');
    $(childs[1]).attr('class','status_waiting_fonts');
    $(childs[2]).html('正在进行');
    var obj_brother = $('#step' + (id-1));
    if (obj_brother.length > 0){
        var childs_b = obj_brother.children();
        $(childs_b[0]).attr('class','status_checked_icon');
        $(childs_b[1]).attr('class','');
        $(childs_b[2]).html(result);
    }
}
var rt_t1=null;
var has_set_interval=false;
function change_to_checked(id, result) {
    if (has_set_interval){
        return;
    }
    has_set_interval=true;
    var obj = $('#step' + id);
    var childs = obj.children();
    $(childs[0]).attr('class','status_checked_icon');
    $(childs[1]).attr('class','');
    $(childs[2]).html(result);
    var time = 8;
    rt_t1 = setInterval(function () {
                if (time <= 0) {
                    go_to_next_tabs(id);
                    $(childs[2]).html(result);
                    return ;
                }
                var  msg = result + '({}秒后跳转下一个界面)';
                msg = msg.replace('{}',time);
                $(childs[2]).html(msg);
                time = time - 1;
            }, 1000);
}

function init_tab5() {
    $('#msg').html('正在获取网卡信息。');
    $('.mywaite').show();
    var srcIdent = getaciTreeChecked('Servers_Tree1');
    var destserverid = getaciTreeChecked('Servers_Tree2');
    var destIdent = destserverid;
    var tmpid = GetAciTreeParent('Servers_Tree2', destserverid);
    if (tmpid == 'ui_1') {
        destserverid = GetAciTreeValue('Servers_Tree2', destserverid, 'peserverid');
    }
    else {
        destIdent = ''; //还原到PE，无路由信息
    }
    params = "destserverid=" + destserverid;
    params += "&srcIdent=" + srcIdent;
    params += "&destIdent=" + destIdent;

    g_adapter_list = null;

    myAjaxGet('../migrate_handle/?a=adaptersettings', params, GetAdapters);
}

function go_to_next_tabs(id) {
    if (src_is_linux()){
        $("#tabs").tabs("option", "active", 5);
        init_tab5();
    }else {
        if (id == 4) {
            $("#tabs").tabs("option", "active", 3);
        }
        else {
            $("#tabs").tabs("option", "active", 4);
        }
    }
    clearInterval(rt_t1);
}

function change_all_to_todo(){
    var trs = $('#check_left tr');
    $.each(trs, function (index, item) {
        var childs = $(item).children();
        $(childs[0]).attr('class','status_todo_icon');
        $(childs[1]).attr('class','');
        $(childs[2]).html('未开始');
    })
}

$(document).on('keyup', 'input[name=client_search]', function () {
    var s_key = $('input[name=client_search]').val().toLowerCase();
    var api = $('#Servers_Tree1').aciTree('api');
    var children = api.children(null,true,true);
	api.radios(children).each(api.proxy(function(element) {
		var node = $(element);
		var label = this.getLabel(node).toLowerCase();
		if (label.indexOf(s_key) ==-1){
			api.hide(node);
		}
		else{
			api.show(node);
		}
	}, true));
});

$(document).on('keyup', 'input[name=client_search2]', function () {
    var s_key = $('input[name=client_search2]').val().toLowerCase();
    var api = $('#Servers_Tree2').aciTree('api');
    var children = api.children(null,true,true);
	api.radios(children).each(api.proxy(function(element) {
		var node = $(element);
		var label = this.getLabel(node).toLowerCase();
		if (label.indexOf(s_key) ==-1){
			api.hide(node);
		}
		else{
			api.show(node);
		}
	}, true));
});

function migrate_resize()
{
	resizeright();
	var width = $('.table_menu').width();
	$("#list").setGridWidth(width);
	baseresize();
}


$(window).resize(function() {
	migrate_resize();	
});

var vue_i1 = new Vue({
    el: '#get_info',
    data:function(){
        return {
        src_host:'WIN-4D22BCC7KHS(172.16.6.26)',
        dst_host:'WIN-4D22BCC7KHS(172.16.6.31)',
        cfm_info:'172.16.6.31',
        i_value:''
        }
    },
    methods:{
        oninput:function () {
            if (this.i_value != this.cfm_info){
                console.log('not same');
                $("#get_info_tmp_cfm").button("option", "disabled", true);
            }else{
                console.log('same');
                $("#get_info_tmp_cfm").button("option", "disabled", false);
            }
        },
        init:function (data) {
            this.src_host = data.src_host;
            this.dst_host = data.dst_host;
            this.cfm_info = data.cfm_info;
            this.i_value = data.i_value;
        }
    }
});

function uplodeCallbkMgr(status, err_o_path) {
	if(status){
		var shell_infos = get_shell_infos_from_ui($('#tabs-shell'));
		shell_infos.zip_tmp_path = err_o_path;
		var other_params = '&shell_infos=' + $.toJSON(shell_infos);
		OnFinish(other_params);
	}
	else {
		openErrorDialog({title:'错误', html:err_o_path});
	}
}

var vm_fast_restore = new Vue({
      el: '#fast_restore',
      data: {
        checked: true
      }
});


function check_disk_migrate(){
    var disks=new Array();
	for(var i=0;i<$('div#HardDisks').children('div').length;i++)
	{
		var divdisk=$('div#HardDisks').children('div')[i].id;
		if(divdisk && $('div#'+divdisk+' input[name="srcharddisk"]').prop("checked"))
		{
			var diskjson={};
			var src=$('div#'+divdisk+' input[name="srcharddisk"]').val().split('|');
			var dest=$('div#'+divdisk+' #storagedevice').val().split('|');
			var a=new Num64(src[1]);
			var b=new Num64(dest[1]);
			if( a.compare(b) == 1 )
			{
				var disk = {ident:src[0],
                    src_name:$('div#'+divdisk+' #srcharddiskname').text(),
                    dst_name:$('div#'+divdisk+' #storagedevice option:selected').text(),
                    value:((parseFloat(src[1])-parseFloat(dest[1]))).toFixed(2)+'GB'
                }
                var error = disk_checker.check(disk);
                if (error){
                    openWarningDialog({title:'警告',html:error,width:550,height:250});
                    return false;
                }
			}

			diskjson.src=src[0];
			diskjson.dest=dest[0];
			disks.push(diskjson);
		}
	}

	if( !CheckDisks(disks) )
	{
		return false;
	}
	return true;
}

$('span.set_disk_step_button').on('click', function () {
    var tbody = $(this).parent().siblings();
    if (tbody.is(':visible')){
        tbody.hide('blind', 800);
        $(this).text('►');
    }
    else{
        tbody.show('blind', 800);
        $(this).text('▼');
    }
});
</script>